name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    
    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}
      
      - name: Add VPS to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
      
      - name: Deploy to VPS
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
            set -e
            export COMPOSE_FILE="docker-compose.yml:docker-compose.prod.yml"
            
            echo "üöÄ Starting deployment..."
            cd ${{ secrets.DEPLOY_PATH }}
            
            echo "üì• Pulling latest code from GitHub..."
            git pull origin main
            
            echo "üîß Fixing file permissions..."
            chown -R 1001:1001 storage bootstrap/cache 2>/dev/null || true
            chmod -R 775 storage bootstrap/cache
            
            echo "üê≥ Rebuilding Docker containers..."
            docker compose build app
            docker compose up -d
            
            echo "üì¶ Installing dependencies..."
            docker compose exec -T app composer install --no-interaction --prefer-dist --optimize-autoloader --no-dev
            
            echo "üé® Building frontend assets..."
            docker compose exec -T app npm ci --prefer-offline --no-audit
            docker compose exec -T app npm run build
            
            echo "üóÑÔ∏è Running migrations..."
            docker compose exec -T app php artisan migrate --force
            
            echo "üßπ Clearing caches..."
            docker compose exec -T app php artisan config:cache
            docker compose exec -T app php artisan route:cache
            docker compose exec -T app php artisan view:cache
            
            echo "üîÑ Restarting workers..."
            docker compose restart queue reverb
            
            echo "‚úÖ Deployment completed!"
          ENDSSH
      
      - name: Verify deployment
        run: |
          echo "‚è≥ Waiting 10 seconds for containers to restart..."
          sleep 10
          
          echo "üîç Checking application health..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.APP_URL }} || echo "000")
          
          if [ "$HTTP_CODE" == "200" ] || [ "$HTTP_CODE" == "302" ]; then
            echo "‚úÖ Application is responding (HTTP $HTTP_CODE)"
          else
            echo "‚ö†Ô∏è Application returned HTTP $HTTP_CODE"
          fi
