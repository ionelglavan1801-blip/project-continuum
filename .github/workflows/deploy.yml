name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    
    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}
      
      - name: Add VPS to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
      
      - name: Deploy to VPS
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
            set -e
            
            echo "ðŸš€ Starting deployment..."
            cd ${{ secrets.DEPLOY_PATH }}
            
            echo "ðŸ“¥ Pulling latest code from GitHub..."
            git pull origin main
            
            echo "ðŸ³ Rebuilding Docker containers..."
            docker compose -f docker-compose.yml -f docker-compose.prod.yml build app
            docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
            
            echo "ðŸ“¦ Installing dependencies..."
            docker compose exec -T app composer install --no-interaction --prefer-dist --optimize-autoloader
            
            echo "ðŸŽ¨ Building frontend assets..."
            docker compose exec -T app npm ci --prefer-offline --no-audit
            docker compose exec -T app npm run build
            
            echo "ðŸ—„ï¸ Running migrations..."
            docker compose exec -T app php artisan migrate --force
            
            echo "ðŸ§¹ Clearing caches..."
            docker compose exec -T app php artisan config:cache
            docker compose exec -T app php artisan route:cache
            docker compose exec -T app php artisan view:cache
            
            echo "ðŸ”„ Restarting workers..."
            docker compose -f docker-compose.yml -f docker-compose.prod.yml restart queue reverb
            
            echo "âœ… Deployment completed!"
          ENDSSH
      
      - name: Verify deployment
        run: |
          echo "â³ Waiting 10 seconds for containers to restart..."
          sleep 10
          
          echo "ðŸ” Checking application health..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.APP_URL }} || echo "000")
          
          if [ "$HTTP_CODE" == "200" ] || [ "$HTTP_CODE" == "302" ]; then
            echo "âœ… Application is responding (HTTP $HTTP_CODE)"
          else
            echo "âš ï¸ Application returned HTTP $HTTP_CODE"
          fi
